machine:
  timezone: UTC
  java:
    version: oraclejdk8
  environment:
    TERM: dumb  # don't let gradle use fancy ansi seq code
    FAKE_S3_ENDPOINT: http://127.0.0.1:19876
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - gem install fakes3
    - docker/setup.sh
    - | # download and cache dependencies
      docker run \
      -w /digdag \
      -v `pwd`/:/digdag \
      -v ~/.gradle:/root/.gradle \
      digdag-build \
      ./gradlew testClasses

test:
  pre:
    - fakes3 -r tmp/fakes3 -p 19876:
        background: true
  override:
    - CI_NODE_INDEX=$CIRCLE_NODE_INDEX ci/run_test.sh:
        parallel: true
  post:
    - mkdir -p $CIRCLE_ARTIFACTS/reports
    - |
      for dir in build/reports digdag-*/build/reports; do
        mkdir -p $CIRCLE_ARTIFACTS/reports/${dir%%/*}
        cp -a $dir $CIRCLE_ARTIFACTS/reports/${dir%%/*}
      done

deployment:
  docs:
    branch: master
    commands:
      - ci/run_deployment.sh

